- name: Create agent user
  ansible.builtin.user:
    name: "{{ agent_username }}"
    comment: "{{ agent_comment }}"
    shell: "{{ agent_shell }}"
    create_home: true
    state: present

- name: Create agent directories
  ansible.builtin.file:
    path: "/home/{{ agent_username }}/{{ item }}"
    state: directory
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0700"
  loop: "{{ agent_directories }}"

- name: Enable lingering for agent user
  ansible.builtin.command:
    cmd: loginctl enable-linger {{ agent_username }}
  register: linger_result
  changed_when: linger_result.rc == 0
  failed_when: false

- name: Copy container files to agent home
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "/home/{{ agent_username }}/{{ item.dest }}"
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "{{ playbook_dir }}/../../mcp-config.json", dest: ".claude/claude_code_config.json", mode: "0644" }
    - { src: "{{ playbook_dir }}/../../build.sh", dest: "build.sh", mode: "0755" }
    - { src: "{{ playbook_dir }}/../../start_container.sh", dest: "start_container.sh", mode: "0755" }
    - { src: "{{ playbook_dir }}/../../Dockerfile", dest: "Dockerfile", mode: "0644" }
